version: '3.0'

expectations:
  population_size: 10000

actions:

## 1. EXTRACT DATA FOR EXPOSED
  generate_community_cases_cohort:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_covid_communitycases
    outputs:
      highly_sensitive:
        cohort: output/input_covid_communitycases.csv


# 2. EXTRACT DATA FOR POTENTIAL COMPARATORS
# new extract potential comparators code... I guess I'll have to this twice for each control group
# or potentially 3 times: 2018 matches, 2019 matches, contemporary matches?

 # *** contemporary potential comparators
  generate_potential_controls_contemporary:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controls_contemporary
    outputs:
      highly_sensitive:
        cohort: output/input_controls_contemporary.csv


# 3. CHECKS ON SEPARATE CASE AND CONTROL FILES - this is for looking to see if they contain per region
  01_longCovidSymp_check_case_control_source:
    run: stata-mp:latest analysis/01_longCovidSymp_check_case_control_source.do
    needs: [generate_community_cases_cohort, generate_potential_controls_contemporary]
    outputs:
      moderately_sensitive:
        log: logs/01_longCovidSymp_check_case_control_source.log



# 4. MATCH CASES TO COMPARATORS
  # *** contemporary potential comparators
  match_contemporary:
    run: python:latest python analysis/match_contemporary.py
    needs: [generate_community_cases_cohort, generate_potential_controls_contemporary]
    outputs:
      moderately_sensitive:
        matching_report: output/matching_report_contemporary.txt
      highly_sensitive:
        matched_cases: output/matched_cases_contemporary.csv
        matched_matches: output/matched_matches_contemporary.csv
        matched_all: output/matched_combined_contemporary.csv



 # 4. ADD FURTHER VARIABLES TO CONTROLS FOLLOWING MATCHING
  add_allVars_contemporary_controls:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_complete_controls_contemporary 
    needs: [match_contemporary]
    outputs:
      highly_sensitive:
        matched_controls_contemporary_wVars: output/input_complete_controls_contemporary.csv



# 5. ADD FURTHER VARIABLES TO CASES FOLLOWING MATCHING
  add_allVars_cases:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_complete_covid_communitycases 
    needs: [match_contemporary]
    outputs:
      highly_sensitive:
        matched_cases_contemporary_wVars: output/input_complete_covid_communitycases.csv







  